<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Horizontal Chat Overlay</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://socialstream.ninja/libs/colours.js" type="text/javascript"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap');

:root {
    --cyber-pink: #ff0066;
    --cyber-cyan: #00ffff;
    --cyber-green: #00ff88;
    --cyber-yellow: #ffcc00;
    --cyber-dark: #0a0a10;
}

body, html {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    font-family: 'Share Tech Mono', monospace;
    background-color: transparent;
    overflow: hidden;
}

#chat-container {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    width: 100%;
    padding: 0 15px;
    box-sizing: border-box;
}

#message-list-wrapper {
    display: flex;
    flex-direction: row;
    align-items: stretch;
    justify-content: flex-start;
    gap: 12px;
    width: 100%;
}

/* Glitch animation on appear */
@keyframes glitchIn {
    0% { 
        opacity: 0;
        transform: translateX(50px) scaleX(0.8);
        filter: hue-rotate(180deg) brightness(2);
    }
    20% { 
        opacity: 1;
        transform: translateX(-10px) scaleX(1.02);
        filter: hue-rotate(90deg) brightness(1.5);
    }
    40% {
        transform: translateX(5px) scaleX(0.98);
        filter: hue-rotate(0deg) brightness(1);
    }
    100% { 
        opacity: 1;
        transform: translateX(0) scaleX(1);
    }
}

@keyframes glitchOut {
    0% { 
        opacity: 1;
        transform: translateX(0);
    }
    100% { 
        opacity: 0;
        transform: translateX(-50px);
        filter: brightness(0.5);
    }
}

/* ==================== */
/* MESSAGE ITEM         */
/* ==================== */
.message-outer {
    flex: 1 1 0;
    min-width: 0;
    max-width: 100%;
    opacity: 0;
    animation: glitchIn 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

.message-outer.removing {
    animation: glitchOut 0.3s ease-out forwards;
}

/* ==================== */
/* NORMAL CHAT          */
/* ==================== */
.message {
    --border-color: var(--cyber-pink);
    display: flex;
    flex-direction: column;
    background: var(--cyber-dark);
    border: 2px solid var(--border-color);
    border-left: 4px solid var(--border-color);
    position: relative;
    height: 85px; /* FIXED HEIGHT - semua box sama */
    box-sizing: border-box;
    overflow: hidden;
}

/* Platform colors */
.message[data-type="youtube"] { --border-color: #ff0000; }
.message[data-type="tiktok"] { --border-color: var(--cyber-cyan); }
.message[data-type="twitch"] { --border-color: #9147ff; }
.message[data-type="kick"] { --border-color: var(--cyber-green); }
.message.streamer { --border-color: var(--cyber-green); }
.message.moderator { --border-color: #9147ff; }
.message.member { --border-color: var(--cyber-cyan); }
.message.donation { --border-color: var(--cyber-pink); }

/* Corner accent */
.message::before {
    content: '';
    position: absolute;
    top: -2px;
    right: -2px;
    width: 8px;
    height: 8px;
    border-top: 2px solid var(--border-color);
    border-right: 2px solid var(--border-color);
}

.message::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: -4px;
    width: 8px;
    height: 8px;
    border-bottom: 2px solid var(--border-color);
    border-left: 2px solid var(--border-color);
}

/* Header row - username on top */
.message-header {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 5px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.03);
    flex-shrink: 0;
    overflow: hidden;
}

.badge-box {
    background: var(--cyber-pink);
    color: #000;
    font-size: 0.6em;
    font-weight: 800;
    padding: 2px 6px;
    font-family: 'Orbitron', sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex-shrink: 0;
}

.badge-box.mod { background: #9147ff; color: #fff; }
.badge-box.member { background: var(--cyber-cyan); color: #000; }
.badge-box.owner { background: var(--cyber-green); color: #000; }
.badge-box.sub { background: var(--cyber-green); color: #000; }
.badge-box.gift { background: var(--cyber-pink); color: #fff; }

.username {
    color: var(--cyber-cyan);
    font-size: 0.8em;
    font-weight: 700;
    font-family: 'Orbitron', sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
    min-width: 0;
}

.message.streamer .username { color: var(--cyber-green); }
.message.moderator .username { color: #bf94ff; }

.action-text {
    color: var(--cyber-yellow);
    font-size: 0.75em;
    font-family: 'Orbitron', sans-serif;
    font-weight: 700;
    flex-shrink: 0;
    white-space: nowrap;
}

.source-icon {
    width: 14px;
    height: 14px;
    opacity: 0.7;
    flex-shrink: 0;
}

/* Message body - FIXED HEIGHT, overflow hidden */
.message-body {
    padding: 8px 10px;
    flex: 1;
    overflow: hidden;
    min-height: 0;
}

.message-text {
    color: #c0c0c0;
    font-size: 0.85em;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 500;
    line-height: 1.4;
    /* Text truncation - kepotong kalau panjang */
    display: -webkit-box;
    -webkit-line-clamp: 2; /* Max 2 baris */
    -webkit-box-orient: vertical;
    overflow: hidden;
    text-overflow: ellipsis;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* FIXED SIZE FOR ALL IMAGES/EMOTES/GIF */
.message-text img {
    width: 24px !important;
    height: 24px !important;
    max-width: 24px !important;
    max-height: 24px !important;
    min-width: 24px !important;
    min-height: 24px !important;
    object-fit: contain;
    vertical-align: middle;
    display: inline-block;
}

/* ==================== */
/* SPECIAL: SUB/DONATE  */
/* ==================== */
.message.special {
    border-width: 2px;
    border-left-width: 4px;
}

.message.special.membership {
    --border-color: var(--cyber-green);
}

.message.special.donation {
    --border-color: var(--cyber-pink);
}

.special-amount {
    color: var(--cyber-yellow);
    font-size: 0.8em;
    font-family: 'Orbitron', sans-serif;
    font-weight: 800;
    flex-shrink: 0;
    white-space: nowrap;
}

/* Pixel decorations for special */
.pixel-wrap {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    pointer-events: none;
}

.pixel {
    position: absolute;
    width: 4px;
    height: 4px;
    background: var(--border-color);
}

.pixel-1 { top: -6px; left: 20%; }
.pixel-2 { top: -6px; right: 20%; }
.pixel-3 { bottom: -6px; left: 30%; }
.pixel-4 { bottom: -6px; right: 30%; }
</style>
</head>
<body>
<div id="chat-container">
    <div id="message-list-wrapper"></div>
</div>
<script>
    // ============================================
    // KONFIGURASI
    // ============================================
    var SESSION_IDS = [
        "CNmktDA5ak",
        "3kLnN2suwn"
    ];
    
    var STREAMER_NAME = "ryubie";
    var MAX_MESSAGES = 4; // Jumlah slot horizontal
    
    // ============================================
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("session")) SESSION_IDS.push(urlParams.get("session"));
    if (urlParams.has("streamer")) STREAMER_NAME = urlParams.get("streamer").toLowerCase();
    if (urlParams.has("limit")) MAX_MESSAGES = parseInt(urlParams.get("limit"));
    
    var password = "false";
    var featuredMode = false;

    const messageListWrapper = document.getElementById('message-list-wrapper');
    const processedMessages = new Set();

    function getBadgeInfo(data) {
        if (data.owner || data.isOwner) return { text: 'OWNER', class: 'owner' };
        if (data.mod || data.isMod || data.moderator) return { text: 'MOD', class: 'mod' };
        if (data.hasDonation || data.donation) return { text: 'GIFT', class: 'gift' };
        if (data.membership) return { text: 'SUB', class: 'sub' };
        if (data.chatbadges) {
            for (let badge of data.chatbadges) {
                const str = typeof badge === 'string' ? badge : (badge.src || '');
                if (str.toLowerCase().includes('vip')) return { text: 'VIP', class: 'vip' };
                if (str.toLowerCase().includes('sub')) return { text: 'SUB', class: 'sub' };
            }
        }
        return null;
    }
    
    function addMessageToOverlay(data) {
        if (!data.chatname && !data.chatmessage && !data.hasDonation && !data.donation) return;
        
        const msgKey = data.mid || (data.chatname + data.chatmessage + (data.hasDonation || ''));
        if (processedMessages.has(msgKey)) return;
        processedMessages.add(msgKey);
        
        if (processedMessages.size > 200) {
            Array.from(processedMessages).slice(0, 100).forEach(k => processedMessages.delete(k));
        }
        
        let isStreamer = false, isModerator = false, isMembership = false, isDonation = false;
        
        if (STREAMER_NAME && data.chatname) {
            const n = data.chatname.toLowerCase();
            if (n === STREAMER_NAME || n.includes(STREAMER_NAME) || STREAMER_NAME.includes(n)) isStreamer = true;
        }
        if (data.owner || data.isOwner) isStreamer = true;
        if (data.membership) isMembership = true;
        if (data.hasDonation || data.donation) isDonation = true;
        if (data.mod || data.isMod || data.moderator) isModerator = true;
        if (data.chatbadges) {
            if (data.chatbadges.some(b => {
                const s = typeof b === 'string' ? b : (b.src || '');
                return s.toLowerCase().includes('moderator') || s.toLowerCase().includes('/mod');
            })) isModerator = true;
        }
        
        const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        let messageOuter = document.createElement('div');
        messageOuter.classList.add('message-outer');
        messageOuter.id = messageId;
        
        // Determine classes
        let msgClasses = ['message'];
        if (data.type) msgClasses.push(data.type.toLowerCase());
        if (isStreamer) msgClasses.push('streamer');
        else if (isModerator) msgClasses.push('moderator');
        if (isMembership) msgClasses.push('member', 'special', 'membership');
        if (isDonation) msgClasses.push('donation', 'special');
        
        // Get badge
        const badge = getBadgeInfo(data);
        const badgeHtml = badge ? `<span class="badge-box ${badge.class}">${badge.text}</span>` : '';
        
        // Action text (for donation amount or membership)
        let actionHtml = '';
        if (isDonation && (data.hasDonation || data.donation)) {
            actionHtml = `<span class="special-amount">${data.hasDonation || data.donation}</span>`;
        } else if (isMembership && data.membership) {
            actionHtml = `<span class="action-text">${data.membership}</span>`;
        }
        
        // Source icon
        const srcIcon = data.type ? `<img src="https://socialstream.ninja/sources/images/${data.type}.png" class="source-icon" alt="">` : '';
        
        // Message text
        const msgText = data.chatmessage || '';
        
        // Pixel decorations for special messages
        const pixelHtml = (isDonation || isMembership) ? `
            <div class="pixel-wrap">
                <div class="pixel pixel-1"></div>
                <div class="pixel pixel-2"></div>
                <div class="pixel pixel-3"></div>
                <div class="pixel pixel-4"></div>
            </div>
        ` : '';
        
        messageOuter.innerHTML = `
            <div class="${msgClasses.join(' ')}" ${data.type ? `data-type="${data.type.toLowerCase()}"` : ''}>
                ${pixelHtml}
                <div class="message-header">
                    ${badgeHtml}
                    <span class="username">${data.chatname || 'ANON'}</span>
                    ${actionHtml}
                    ${srcIcon}
                </div>
                <div class="message-body">
                    <span class="message-text">${msgText || '&nbsp;'}</span>
                </div>
            </div>
        `;

        // Add to wrapper
        messageListWrapper.appendChild(messageOuter);
        
        // Remove OLDEST message when exceeds MAX
        const messages = messageListWrapper.querySelectorAll('.message-outer');
        if (messages.length > MAX_MESSAGES) {
            const oldest = messages[0];
            oldest.classList.add('removing');
            setTimeout(() => {
                if (oldest.parentNode) oldest.remove();
            }, 300);
        }
    }

    // === SETUP SESSIONS ===
    SESSION_IDS.forEach(roomID => {
        const iframe = document.createElement("iframe");
        iframe.src = featuredMode 
            ? `https://vdo.socialstream.ninja/?ln&password=${password}&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`
            : `https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&password=${password}&push&label=dock&vd=0&ad=0&novideo&noaudio&autostart&cleanoutput&room=${roomID}`;
        iframe.style.cssText = "width:0;height:0;position:fixed;left:-100px;top:-100px;";
        document.body.appendChild(iframe);
        
        let conCon = 1;
        const serverURL = urlParams.has("localserver") ? "ws://127.0.0.1:3000" : "wss://io.socialstream.ninja";
        
        function setupSocket(){
            const ws = new WebSocket(serverURL);
            ws.onclose = () => setTimeout(() => { conCon++; setupSocket(); }, 100*conCon);
            ws.onopen = () => { conCon = 1; ws.send(JSON.stringify({"join":roomID, "out":3, "in":4})); };
            ws.onmessage = e => { try { addMessageToOverlay(JSON.parse(e.data)); } catch(err){} };
        }
        
        if (urlParams.has("server") || urlParams.has("server2")) setupSocket();
        console.log("Connected:", roomID);
    });
    
    window.addEventListener("message", e => {
        if (e.data.dataReceived?.overlayNinja) addMessageToOverlay(e.data.dataReceived.overlayNinja);
    });
</script>
</body>
</html>
