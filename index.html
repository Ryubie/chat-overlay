<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyberpunk Chat Overlay</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://socialstream.ninja/libs/colours.js" type="text/javascript"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&family=Rajdhani:wght@400;500;600;700&display=swap');

:root {
    --cyber-pink: #ff0066;
    --cyber-cyan: #00ffff;
    --cyber-green: #00ff88;
    --cyber-yellow: #ffff00;
    --cyber-dark: #0d0d14;
}

body, html {
    margin: 0;
    padding: 0;
    width: 100%;
    height: 100%;
    font-family: 'Share Tech Mono', monospace;
    background-color: transparent;
    overflow: hidden;
}

#chat-container {
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 480px;
    height: 100vh;
    overflow: hidden;
    padding: 0 25px;
    box-sizing: border-box;
}

#message-list-wrapper {
    width: 100%;
    transition: transform 0.5s ease-out;
    padding-top: 25px;
}

/* ==================== */
/* GLITCH ON APPEAR     */
/* ==================== */
@keyframes glitchIn {
    0% { 
        opacity: 0;
        transform: translateX(-30px);
        clip-path: inset(0 100% 0 0);
    }
    20% { 
        opacity: 1;
        transform: translateX(8px) skewX(-2deg);
        clip-path: inset(0 0 0 0);
        filter: hue-rotate(90deg) brightness(2);
    }
    25% {
        transform: translateX(-4px) skewX(1deg);
        filter: hue-rotate(0deg) brightness(1);
    }
    30% { 
        transform: translateX(2px);
    }
    100% { 
        opacity: 1;
        transform: translateX(0);
    }
}

@keyframes glitchInSpecial {
    0% { 
        opacity: 0;
        transform: scale(0.9) translateY(20px);
        filter: brightness(3) hue-rotate(180deg);
    }
    15% {
        opacity: 1;
        transform: scale(1.02) translateY(-5px);
        filter: brightness(2) hue-rotate(90deg);
    }
    25% {
        transform: scale(0.98) translateY(3px);
        filter: brightness(1.5) hue-rotate(45deg);
    }
    35% {
        transform: scale(1.01) translateY(-2px);
        filter: brightness(1) hue-rotate(0deg);
    }
    100% { 
        opacity: 1;
        transform: scale(1) translateY(0);
        filter: brightness(1) hue-rotate(0deg);
    }
}

/* ==================== */
/* MESSAGE CONTAINER    */
/* ==================== */
.message-outer {
    position: relative;
    margin-bottom: 12px;
    opacity: 0;
}

.message-outer.visible {
    animation: glitchIn 0.4s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

.message-outer.special-style.visible {
    animation: glitchInSpecial 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
}

/* ==================== */
/* NORMAL CHAT          */
/* ==================== */
.message {
    position: relative;
    background: rgba(13, 13, 20, 0.95);
    border-left: 3px solid var(--cyber-pink);
    padding: 10px 14px;
    color: #ffffff;
}

/* Platform border colors */
.message[data-type="youtube"] { border-left-color: #ff0000; }
.message[data-type="tiktok"] { border-left-color: var(--cyber-cyan); }
.message[data-type="twitch"] { border-left-color: #9147ff; }
.message[data-type="kick"] { border-left-color: var(--cyber-green); }
.message[data-type="facebook"] { border-left-color: #0066ff; }
.message.streamer { border-left-color: var(--cyber-green); }
.message.moderator { border-left-color: #9147ff; }

/* Username row */
.username-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 4px;
}

.username-prefix {
    color: var(--cyber-pink);
    font-size: 0.95em;
    font-weight: bold;
}

.message.streamer .username-prefix { color: var(--cyber-green); }
.message.moderator .username-prefix { color: #9147ff; }
.message[data-type="youtube"] .username-prefix { color: #ff0000; }
.message[data-type="twitch"] .username-prefix { color: #9147ff; }
.message[data-type="tiktok"] .username-prefix { color: var(--cyber-cyan); }

.username {
    color: var(--cyber-cyan);
    font-size: 0.9em;
    font-weight: 700;
    font-family: 'Orbitron', sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.message.streamer .username { color: var(--cyber-green); }
.message.moderator .username { color: #bf94ff; }

.badge-box {
    background: var(--cyber-pink);
    color: #000;
    font-size: 0.6em;
    font-weight: 800;
    padding: 2px 6px;
    font-family: 'Orbitron', sans-serif;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.badge-box.mod { background: #9147ff; color: #fff; }
.badge-box.vip { background: var(--cyber-pink); }
.badge-box.member { background: var(--cyber-cyan); color: #000; }
.badge-box.owner { background: var(--cyber-green); color: #000; }

/* Message text */
.message-row {
    display: flex;
    align-items: flex-start;
    gap: 6px;
}

.message-prefix {
    color: var(--cyber-pink);
    font-size: 0.9em;
    opacity: 0.6;
}

.message.streamer .message-prefix { color: var(--cyber-green); }
.message.moderator .message-prefix { color: #9147ff; }

.message-text {
    color: #d0d0d0;
    font-size: 0.92em;
    line-height: 1.45;
    word-wrap: break-word;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 500;
}

.message-text img {
    max-width: 100%;
    max-height: 80px;
    display: block;
    margin-top: 6px;
    border: 1px solid var(--cyber-pink);
}

/* Source icon */
.source-icon {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 16px;
    height: 16px;
    opacity: 0.7;
}

/* Chat badges */
.badges-wrap {
    display: flex;
    gap: 3px;
    margin-left: auto;
}

.chat-badge {
    height: 14px;
    opacity: 0.9;
}

/* ==================== */
/* SPECIAL: SUB/DONATE  */
/* ==================== */
.message-outer.special-style {
    margin-bottom: 18px;
}

.special-container {
    position: relative;
}

/* Pixel decorations */
.pixel {
    position: absolute;
    width: 5px;
    height: 5px;
    background: var(--cyber-pink);
}

.pixel-1 { top: -7px; left: 15%; }
.pixel-2 { top: -7px; left: 35%; }
.pixel-3 { top: -7px; right: 35%; }
.pixel-4 { top: -7px; right: 15%; }
.pixel-5 { bottom: -7px; left: 20%; }
.pixel-6 { bottom: -7px; right: 20%; }
.pixel-7 { top: 30%; left: -7px; }
.pixel-8 { top: 30%; right: -7px; }
.pixel-9 { bottom: 30%; left: -7px; }
.pixel-10 { bottom: 30%; right: -7px; }

.special-box {
    background: rgba(13, 13, 20, 0.98);
    border: 2px solid var(--cyber-pink);
    position: relative;
}

.special-header {
    background: rgba(255, 0, 102, 0.15);
    border-bottom: 1px solid var(--cyber-pink);
    padding: 5px 12px;
    text-align: center;
}

.special-label {
    color: var(--cyber-pink);
    font-size: 0.65em;
    font-family: 'Share Tech Mono', monospace;
    font-weight: 600;
    letter-spacing: 2px;
    text-transform: uppercase;
}

.special-body {
    padding: 10px 15px;
    text-align: center;
}

.special-username {
    color: #ffffff;
    font-size: 1em;
    font-family: 'Orbitron', sans-serif;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.special-action {
    color: var(--cyber-cyan);
    font-size: 0.85em;
    font-family: 'Orbitron', sans-serif;
    font-weight: 600;
    margin-left: 10px;
}

.special-amount {
    color: var(--cyber-yellow);
    font-size: 0.95em;
    font-family: 'Orbitron', sans-serif;
    font-weight: 800;
    margin-left: 8px;
}

/* Message box below */
.special-message {
    background: rgba(13, 13, 20, 0.95);
    border: 1px solid rgba(255, 0, 102, 0.4);
    border-top: none;
    padding: 10px 15px;
    margin-top: -1px;
}

.special-message-text {
    color: #b0b0b0;
    font-size: 0.88em;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 500;
    text-align: center;
    margin: 0;
    line-height: 1.4;
}

/* Membership - Green variant */
.special-box.membership {
    border-color: var(--cyber-green);
}

.special-box.membership .special-header {
    background: rgba(0, 255, 136, 0.1);
    border-color: var(--cyber-green);
}

.special-box.membership .special-label {
    color: var(--cyber-green);
}

.special-container.membership .pixel {
    background: var(--cyber-green);
}

.special-container.membership .special-message {
    border-color: rgba(0, 255, 136, 0.4);
}

#spacer {
    width: 100%;
    background: transparent;
}
</style>
</head>
<body>
<div id="chat-container">
    <div id="message-list-wrapper">
        <div id="spacer" style="height: 2200px;"></div>
    </div>
</div>
<script>
    // ============================================
    // KONFIGURASI
    // ============================================
    var SESSION_IDS = [
        "CNmktDA5ak",
        "3kLnN2suwn"
    ];
    
    var STREAMER_NAME = "ryubie";
    var MAX_MESSAGES = 20;
    
    // ============================================
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has("session")) SESSION_IDS.push(urlParams.get("session"));
    if (urlParams.has("streamer")) STREAMER_NAME = urlParams.get("streamer").toLowerCase();
    if (urlParams.has("limit")) MAX_MESSAGES = parseInt(urlParams.get("limit"));
    
    var password = "false";
    var featuredMode = false;
    var reversed = urlParams.has("reverse");

    const chatContainer = document.getElementById('chat-container');
    const messageListWrapper = document.getElementById('message-list-wrapper');
    const topSpacer = document.getElementById('spacer');

    if (reversed) {
        topSpacer.style.display = 'none';
        chatContainer.style.bottom = 'auto';
        chatContainer.style.top = '0';
    }
    
    const MAX_SPACER_HEIGHT_BEFORE_RESET = 18000000;
    const processedMessages = new Set();

    function adjustMessageWrapperScroll() {
        if (reversed) return;
        requestAnimationFrame(() => {
            const wrapperScrollHeight = messageListWrapper.scrollHeight;
            const containerClientHeight = chatContainer.clientHeight;
            let translateY = 0;
            if (wrapperScrollHeight > containerClientHeight) {
                translateY = -(wrapperScrollHeight - containerClientHeight);
            }
            messageListWrapper.style.transform = `translateY(${Math.min(0, translateY)}px)`;
        });
    }
    
    function getBadgeInfo(data) {
        if (data.owner || data.isOwner) return { text: 'OWNER', class: 'owner' };
        if (data.mod || data.isMod || data.moderator) return { text: 'MOD', class: 'mod' };
        if (data.membership) return { text: 'MEMBER', class: 'member' };
        if (data.chatbadges) {
            for (let badge of data.chatbadges) {
                const str = typeof badge === 'string' ? badge : (badge.src || '');
                if (str.toLowerCase().includes('vip')) return { text: 'VIP', class: 'vip' };
                if (str.toLowerCase().includes('sub')) return { text: 'SUB', class: 'member' };
            }
        }
        return null;
    }
    
    function addMessageToOverlay(data) {
        if (!data.chatname && !data.chatmessage && !data.hasDonation && !data.donation && !data.contentimg) return;
        
        const msgKey = data.mid || (data.chatname + data.chatmessage + (data.hasDonation || ''));
        if (processedMessages.has(msgKey)) return;
        processedMessages.add(msgKey);
        
        if (processedMessages.size > 200) {
            Array.from(processedMessages).slice(0, 100).forEach(k => processedMessages.delete(k));
        }
        
        let isStreamer = false, isModerator = false, isMembership = false, isDonation = false;
        
        if (STREAMER_NAME && data.chatname) {
            const n = data.chatname.toLowerCase();
            if (n === STREAMER_NAME || n.includes(STREAMER_NAME) || STREAMER_NAME.includes(n)) isStreamer = true;
        }
        if (data.owner || data.isOwner) isStreamer = true;
        if (data.membership) isMembership = true;
        if (data.hasDonation || data.donation) isDonation = true;
        if (data.mod || data.isMod || data.moderator) isModerator = true;
        if (data.chatbadges) {
            if (data.chatbadges.some(b => {
                const s = typeof b === 'string' ? b : (b.src || '');
                return s.toLowerCase().includes('moderator') || s.toLowerCase().includes('/mod');
            })) isModerator = true;
        }
        
        const messageId = data.mid || 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        let messageOuter = document.createElement('div');
        messageOuter.id = messageId;
        
        if ((isDonation || isMembership) && !isStreamer) {
            // === SPECIAL STYLE ===
            messageOuter.classList.add('message-outer', 'special-style');
            
            const isMem = isMembership && !isDonation;
            const typeClass = isMem ? 'membership' : 'donation';
            const label = isMem ? 'NEW SUBSCRIBER' : 'NEW DONATION';
            const action = isDonation ? '' : (data.membership || 'SUBSCRIBED');
            const amount = isDonation ? (data.hasDonation || data.donation || '') : '';
            const msg = data.chatmessage || '';
            
            let html = `
                <div class="special-container ${typeClass}">
                    <div class="pixel pixel-1"></div>
                    <div class="pixel pixel-2"></div>
                    <div class="pixel pixel-3"></div>
                    <div class="pixel pixel-4"></div>
                    <div class="pixel pixel-5"></div>
                    <div class="pixel pixel-6"></div>
                    <div class="pixel pixel-7"></div>
                    <div class="pixel pixel-8"></div>
                    <div class="pixel pixel-9"></div>
                    <div class="pixel pixel-10"></div>
                    <div class="special-box ${typeClass}">
                        <div class="special-header">
                            <span class="special-label">[ ${label} ]</span>
                        </div>
                        <div class="special-body">
                            <span class="special-username">${data.chatname || 'ANONYMOUS'}</span>
                            ${action ? `<span class="special-action">${action}</span>` : ''}
                            ${amount ? `<span class="special-amount">${amount}</span>` : ''}
                        </div>
                    </div>
                    ${msg ? `<div class="special-message"><p class="special-message-text">${msg}</p></div>` : ''}
                </div>
            `;
            messageOuter.innerHTML = html;
            
        } else {
            // === NORMAL CHAT ===
            messageOuter.classList.add('message-outer');
            
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('message');
            if (data.type) msgDiv.setAttribute('data-type', data.type.toLowerCase());
            if (isStreamer) msgDiv.classList.add('streamer');
            else if (isModerator) msgDiv.classList.add('moderator');
            
            const badge = getBadgeInfo(data);
            const badgeHtml = badge ? `<span class="badge-box ${badge.class}">${badge.text}</span>` : '';
            
            const srcIcon = data.type ? `<img src="https://socialstream.ninja/sources/images/${data.type}.png" class="source-icon" alt="">` : '';
            
            let badgesHtml = '';
            if (data.chatbadges) {
                data.chatbadges.forEach(b => {
                    const src = typeof b === 'object' ? b.src : b;
                    if (src) badgesHtml += `<img class="chat-badge" src="${src}" alt="">`;
                });
            }
            
            const contentImg = data.contentimg ? `<img src="${data.contentimg}" onerror="this.style.display='none'">` : '';

            msgDiv.innerHTML = `
                ${srcIcon}
                <div class="username-row">
                    <span class="username-prefix">+</span>
                    <span class="username">${data.chatname || 'ANON'}</span>
                    ${badgeHtml}
                    ${badgesHtml ? `<div class="badges-wrap">${badgesHtml}</div>` : ''}
                </div>
                <div class="message-row">
                    <span class="message-prefix">â€º</span>
                    <span class="message-text">${data.chatmessage || ''}${contentImg}</span>
                </div>
            `;
            
            messageOuter.appendChild(msgDiv);
        }

        if (reversed) {
            const first = messageListWrapper.querySelector('.message-outer');
            if (first) messageListWrapper.insertBefore(messageOuter, first);
            else messageListWrapper.appendChild(messageOuter);
        } else {
            messageListWrapper.appendChild(messageOuter);
        }
        
        // Trigger animation
        requestAnimationFrame(() => {
            messageOuter.classList.add('visible');
        });
        
        const messages = Array.from(messageListWrapper.children).filter(c => c.classList.contains('message-outer'));
        
        if (messages.length > MAX_MESSAGES) {
            const oldest = reversed ? messages[messages.length - 1] : messages[0];
            if (oldest) {
                if (!reversed) {
                    const h = oldest.offsetHeight + (parseFloat(getComputedStyle(oldest).marginBottom) || 0);
                    let newH = (parseFloat(topSpacer.style.height) || 0) + h;
                    if (newH > MAX_SPACER_HEIGHT_BEFORE_RESET) newH = 0;
                    topSpacer.style.height = newH + 'px';
                }
                messageListWrapper.removeChild(oldest);
            }
        }
        
        adjustMessageWrapperScroll();
    }

    // === SETUP SESSIONS ===
    SESSION_IDS.forEach(roomID => {
        const iframe = document.createElement("iframe");
        iframe.src = featuredMode 
            ? `https://vdo.socialstream.ninja/?ln&password=${password}&salt=vdo.ninja&label=overlay&exclude=${roomID}&scene&novideo&noaudio&cleanoutput&room=${roomID}`
            : `https://vdo.socialstream.ninja/?ln&salt=vdo.ninja&password=${password}&push&label=dock&vd=0&ad=0&novideo&noaudio&autostart&cleanoutput&room=${roomID}`;
        iframe.style.cssText = "width:0;height:0;position:fixed;left:-100px;top:-100px;";
        document.body.appendChild(iframe);
        
        let conCon = 1;
        const serverURL = urlParams.has("localserver") ? "ws://127.0.0.1:3000" : "wss://io.socialstream.ninja";
        
        function setupSocket(){
            const ws = new WebSocket(serverURL);
            ws.onclose = () => setTimeout(() => { conCon++; setupSocket(); }, 100*conCon);
            ws.onopen = () => { conCon = 1; ws.send(JSON.stringify({"join":roomID, "out":3, "in":4})); };
            ws.onmessage = e => { try { addMessageToOverlay(JSON.parse(e.data)); } catch(err){} };
        }
        
        if (urlParams.has("server") || urlParams.has("server2")) setupSocket();
        console.log("Connected:", roomID);
    });
    
    window.addEventListener("message", e => {
        if (e.data.dataReceived?.overlayNinja) addMessageToOverlay(e.data.dataReceived.overlayNinja);
    });
</script>
</body>
</html>
